
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://feng003.github.io/mysql/leetcode/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.3">
    
    
      
        <title>Leetcode - 我的文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#leetcode-mysql" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="我的文档" class="md-header__button md-logo" aria-label="我的文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            我的文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Leetcode
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/feng003/wiki/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Github
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="我的文档" class="md-nav__button md-logo" aria-label="我的文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    我的文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/feng003/wiki/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../kali/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kali
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MySql
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#leetcode-mysql" class="md-nav__link">
    leetcode mysql
  </a>
  
    <nav class="md-nav" aria-label="leetcode mysql">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#601-aid-bid-1-and-bid1-cid-row_number" class="md-nav__link">
    601. 体育馆的人流量  连续（a.id = b.id-1 and b.id+1 = c.id）/ row_number()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#180" class="md-nav__link">
    180. 连续出现的数字
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#550-iv" class="md-nav__link">
    550. 游戏玩法分析 IV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#585-2016" class="md-nav__link">
    585. 2016年的投资
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1164-join-null" class="md-nav__link">
    1164. 指定日期的产品价格 全集 JOIN 子集 缺失的值为null
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1204" class="md-nav__link">
    1204. 最后一个能进入巴士的人
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1280" class="md-nav__link">
    1280. 学生们参加各科测试的次数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1321-date_sub-datediff" class="md-nav__link">
    1321. 餐馆营业额变化增长  date_sub() / datediff()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1934-avg-if" class="md-nav__link">
    1934. 确认率  AVG() / if()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#181" class="md-nav__link">
    181. 超过经理收入的员工
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#184-dense_rank" class="md-nav__link">
    184. 部门工资最高的员工  DENSE_RANK()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#197-datediff-timestampdiff" class="md-nav__link">
    197. 上升的温度 datediff() / TIMESTAMPDIFF()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#610-case-when-xx-then-x-else-x-end" class="md-nav__link">
    610. 判断三角形  case when xx then x else x end
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#626-lead-lag-if" class="md-nav__link">
    626. 换座位  LEAD(), LAG() / IF()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1084-iii-count-sale_date-between-2019-01-01-and-2019-03-31-or-null" class="md-nav__link">
    1084. 销售分析III count( sale_date between '2019-01-01' and '2019-03-31' or null )
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1174-ii-x-x-in-x-x-sumx-x" class="md-nav__link">
    1174. 即时食物配送 II   (x, x) in (x, x) / SUM(x = x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1193-i-if-sum-date_formatdate-format" class="md-nav__link">
    1193. 每月交易 I  IF / SUM / DATE_FORMAT(date, format)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1321" class="md-nav__link">
    1321. 餐馆营业额变化增长
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1789-union-if" class="md-nav__link">
    1789. 员工的直属部门  UNION / IF()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1934-avg-ifnull" class="md-nav__link">
    1934. 确认率  AVG() IFNULL
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Leetcode</h1>

<h2 id="leetcode-mysql">leetcode mysql</h2>
<pre><code>AVG()属于聚合函数,它接受的参数可以是字段名,也可以是返回数字的表达式。
类似的 MIN(),MAX(),SUM() 都是可以的， 特殊的count用法：
count(age &gt; 20 or null) 如果是 count(age &gt; 20) = count(*) 
对于非聚合函数如ABS(), UPPER()等,就只能接受字段作为参数.

// 窗口函数
SELECT score, ROW_NUMBER() OVER(order by score desc) AS 'rank' FROM Scores;
SELECT S.score, DENSE_RANK() OVER (PARTITION BY id ORDER BY S.score DESC ) AS 'rank' FROM Scores S;

// 字符串操作函数
SUBSTRING(column_name, start, length)
CONCAT(string1, string2, ...)

SELECT user_id, CONCAT(UPPER(substring(name,1,1)), LOWER(substring(name,2)) ) as name 
FROM Users order by user_id

SELECT user_id, CONCAT(UPPER(substring(name,1,1)), LOWER(substring(name,2)) ) as name 
FROM Users order by user_id

// 模糊匹配 邮箱 (^[a-zA-Z][a-zA-Z0-9_.-]*\\@leetcode\\.com$)
SELECT * FROM Patients WHERE conditions REGEXP '\\bDIAB1.*';
SELECT * FROM Patients where conditions like 'DIAB1%' or conditions like '% DIAB1%';
SELECT * FROM Users where mail REGEXP '^[a-zA-Z][a-zA-Z0-9_.-]*\\@leetcode\\.com$'

// GROUP_CONCAT() / count( distinct() )
SELECT sell_date, count( distinct(product) ) as num_sold, 
GROUP_CONCAT(DISTINCT product ORDER BY product SEPARATOR ',') as products 
FROM Activities group by sell_date ORDER BY  sell_date ASC;
</code></pre>
<hr />
<h3 id="601-aid-bid-1-and-bid1-cid-row_number">601. 体育馆的人流量  连续（a.id = b.id-1 and b.id+1 = c.id）/ row_number()</h3>
<pre><code>### 找出每行的人数大于或等于 100 且 id 连续的三行或更多行记录
Stadium =
| id | visit_date | people |
| -- | ---------- | ------ |
| 1  | 2017-01-01 | 10     |
| 2  | 2017-01-02 | 109    |
| 3  | 2017-01-03 | 150    |
| 4  | 2017-01-04 | 99     |
| 5  | 2017-01-05 | 145    |
| 6  | 2017-01-06 | 1455   |
| 7  | 2017-01-07 | 199    |
| 8  | 2017-01-09 | 188    |

### 思路1 三表连接 比较  a.id = b.id-1 and b.id+1 = c.id
SELECT a.* FROM stadium as a,stadium as b,stadium as c where (a.id = b.id-1 and b.id+1 = c.id)

### 思路2 窗口函数
SELECT *,id - row_number() over(order by id) as rk FROM stadium  where people &gt;= 100

with t1 as (
select *,id - row_number() over(order by id) as rk from stadium  where people &gt;= 100
)
select id,visit_date, people from t1 where rk in ( select rk from t1 group by rk having count(rk) &gt;= 3 )
</code></pre>
<h3 id="180">180. 连续出现的数字</h3>
<pre><code>### 按照ID升序排序下，统计num中连续重复出现3次及以上的数字

Logs =
| id | num |
| -- | --- |
| 1  | 1   |
| 2  | 1   |
| 3  | 1   |
| 4  | 2   |
| 5  | 1   |
| 6  | 2   |
| 7  | 2   |

### 答案 三个表之间的关系
SELECT DISTINCT l1.Num AS ConsecutiveNums FROM Logs l1,Logs l2, Logs l3 
WHERE (l1.Id = l2.Id - 1 AND l2.Id = l3.Id - 1) AND l1.Num = l2.Num AND l2.Num = l3.Num;

### 答案 
### 判断是否连续，若考虑id不连续的情况，光凭题目中的id就不够用了，我们可利用row_num函数按照id 升序对其进行连续排序，
row_number() over(order by id) 记为rank1

### 统计num的重复数据，自然需要对num进行分组统计，同样对其进行排名 row_number() over(partition by Num order by Id) 记为rank2

SELECT DISTINCT Num ConsecutiveNums FROM (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY Num ORDER BY Id) rownum,
    ROW_NUMBER() OVER (ORDER BY Id) id2 FROM LOGS ) t
GROUP BY (id2-rownum) ,Num HAVING COUNT(*)&gt;=3
</code></pre>
<hr />
<h3 id="550-iv">550. 游戏玩法分析 IV</h3>
<pre><code>### 计算从首次登录日期开始至少连续两天登录的玩家的数量，然后除以玩家总数。
Activity =
| player_id | device_id | event_date | games_played |
| --------- | --------- | ---------- | ------------ |
| 1         | 2         | 2016-03-01 | 5            |
| 1         | 2         | 2016-03-02 | 6            |
| 2         | 3         | 2017-06-25 | 1            |
| 3         | 1         | 2016-03-02 | 0            |
| 3         | 4         | 2018-07-03 | 5            |

### 思路1
先过滤出每个用户的首次登陆日期，然后左关联，筛选次日存在的记录的比例

### 答案
SELECT round(avg(a.event_date is not null), 2) fraction FROM 
(SELECT player_id, min(event_date) as login FROM activity group by player_id ) as p left JOIN 
activity as a on p.player_id=a.player_id and datediff(a.event_date, p.login)=1

### 答案2
SELECT round( ((SELECT count(player_id) FROM 
(SELECT player_id, datediff(event_date, min(event_date) over(partition by player_id)) as diff FROM activity ) as tmp 
where diff = 1 ) / (SELECT count(distinct player_id) FROM activity)) ,2) as fraction;
</code></pre>
<h3 id="585-2016">585. 2016年的投资</h3>
<pre><code>### 报告 2016 年 (tiv_2016) 所有满足下述条件的投保人的投保金额之和：
    在 2015 年的投保额 (tiv_2015) 至少跟一个其他投保人在 2015 年的投保额相同。
    所在的城市必须与其他投保人都不同（也就是说 (lat, lon) 不能跟其他任何一个投保人完全相同）。

Insurance =
| pid | tiv_2015 | tiv_2016 | lat | lon |
| --- | -------- | -------- | --- | --- |
| 1   | 10       | 5        | 10  | 10  |
| 2   | 20       | 20       | 20  | 20  |
| 3   | 10       | 30       | 20  | 20  |
| 4   | 10       | 40       | 40  | 40  |

### 思路1
SELECT round(sum(r1.tiv_2016),2) as tiv_2016 FROM 
(SELECT pid,tiv_2016 FROM Insurance where tiv_2015 in (SELECT tiv_2015 FROM Insurance group by tiv_2015 having count(1) &gt; 1) ) as r1 JOIN 
( SELECT pid,tiv_2016 FROM Insurance group by lat,lon having count(1) = 1 ) as r2 on r1.pid = r2.pid

### 思路2
SELECT round(sum(tiv_2016),2) as tiv_2016 FROM Insurance 
where tiv_2015 in ( SELECT tiv_2015 FROM Insurance group by tiv_2015 having count(1) &gt; 1 ) 
and concat(lat, lon) in (SELECT concat(lat, lon) FROM Insurance group by lat,lon having count(1) = 1 );
</code></pre>
<h3 id="1164-join-null">1164. 指定日期的产品价格 全集 JOIN 子集 缺失的值为null</h3>
<pre><code>### 查找在 2019-08-16 时全部产品的价格，假设所有产品在修改前的价格都是 10

Product = 
| product_id | new_price | change_date |
| ---------- | --------- | ----------- |
| 1          | 20        | 2019-08-14  |
| 2          | 50        | 2019-08-14  |
| 1          | 30        | 2019-08-15  |
| 1          | 35        | 2019-08-16  |
| 2          | 65        | 2019-08-17  |
| 3          | 20        | 2019-08-18  |

### 思路1
SELECT product_id,new_price as price FROM Products where (product_id,change_date) in (SELECT product_id, max(change_date) FROM Products where change_date &lt;= "2019-08-16" group by product_id)
union
(SELECT product_id, if(2&gt;1, 10, 10) as price FROM Products where change_date &gt;'2019-08-16' group by product_id having count(1) &lt; 2 )

### 思路2
SELECT product_id, price FROM ( SELECT product_id, new_price as price, dense_rank() over(partition by product_id order by change_date desc) as rnk FROM Products where change_date &lt;= '2019-08-16' ) t where rnk = 1

### 答案1 全集 JOIN 子集 缺失的值为null

SELECT p1.product_id, ifnull(p2.new_price, 10) as price FROM
 (SELECT distinct product_id FROM Products ) as p1  left JOIN 
 (SELECT product_id,new_price FROM Products where (product_id,change_date) in (SELECT product_id, max(change_date) 
 FROM Products where change_date &lt;= "2019-08-16" group by product_id) ) as p2
 on p1.product_id=p2.product_id

 ### 答案2 COALESCE(expr1, expr2, ..., default_value) 
 ### COALESCE函数是用于从一组表达式中返回第一个非空的值的非常有用的函数，特别适用于处理多个列或表达式的情况
 SELECT distinct p1.product_id, 
 coalesce(( SELECT p2.new_price FROM Products as p2 where p2.change_date &lt;= '2019-08-16' and p1.product_id=p2.product_id order by p2.change_date desc limit 1 )  ,10) as price 
 FROM Products as p1
</code></pre>
<h3 id="1204">1204. 最后一个能进入巴士的人</h3>
<pre><code>### 最后一个 上巴士且不超过重量限制(1000)的乘客，并报告 person_name

Queue =
| person_id | person_name | weight | turn |
| --------- | ----------- | ------ | ---- |
| 5         | Alice       | 250    | 1    |
| 4         | Bob         | 175    | 5    |
| 3         | Alex        | 350    | 2    |
| 6         | John Cena   | 400    | 3    |
| 1         | Winston     | 500    | 6    |
| 2         | Marie       | 200    | 4    |

### 答案 窗口函数
SELECT turn, person_name, sum(weight) over(order by turn) as cumu_weight FROM Queue

SELECT r.person_name FROM 
 (SELECT turn, person_name, sum(weight) over(order by turn) as cumu_weight FROM Queue ) as r 
 where r.cumu_weight &lt;= 1000 order by turn desc limit 1;

### 答案 半连接
SELECT person_name  FROM Queue q1
where (SELECT sum(weight) FROM Queue where turn &lt;= q1.turn) &lt;= 1000
order by turn desc limit 1

### 答案 自连接  a.turn &gt;= b.turn 找到所有在他之前以及他自己的重量
SELECT a.person_name  FROM Queue a, Queue b  WHERE a.turn &gt;= b.turn
GROUP BY a.person_id HAVING SUM(b.weight) &lt;= 1000
ORDER BY a.turn DESC LIMIT 1

### 自定义变量
SELECT a.person_name FROM 
( SELECT person_name, @pre := @pre + weight AS weight FROM Queue, 
(SELECT @pre := 0) tmp ORDER BY turn ) a WHERE a.weight &lt;= 1000 ORDER BY a.weight DESC  LIMIT 1
</code></pre>
<h3 id="1280">1280. 学生们参加各科测试的次数</h3>
<pre><code>### 查询出每个学生参加每一门科目测试的次数，结果按 student_id 和 subject_name 排序
Students =
| student_id | student_name |
| ---------- | ------------ |
| 1          | Alice        |
| 2          | Bob          |
| 13         | John         |
| 6          | Alex         |

Subjects =
| subject_name |
| ------------ |
| Math         |
| Physics      |
| Programming  |

Examinations =
| student_id | subject_name |
| ---------- | ------------ |
| 1          | Math         |
| 1          | Physics      |
| 1          | Programming  |
| 2          | Programming  |
| 1          | Physics      |
| 1          | Math         |
| 13         | Math         |
| 13         | Programming  |
| 13         | Physics      |
| 2          | Math         |
| 1          | Math         |

### 答案
SELECT s.student_id, s.student_name, su.subject_name, COUNT(e.subject_name) AS attended_exams FROM Students AS s
JOIN Subjects AS su LEFT JOIN  Examinations AS e
ON e.student_id = s.student_id AND e.subject_name = su.subject_name
GROUP BY  s.student_id,su.subject_name ORDER BY  s.student_id,su.subject_name

### 答案
SELECT s.student_id, s.student_name, sub.subject_name, IFNULL(grouped.attended_exams, 0) AS attended_exams
FROM Students s CROSS JOIN Subjects sub LEFT JOIN ( SELECT student_id, subject_name, COUNT(*) AS attended_exams FROM Examinations GROUP BY student_id, subject_name ) grouped 
ON s.student_id = grouped.student_id AND sub.subject_name = grouped.subject_name ORDER BY s.student_id, sub.subject_name;
</code></pre>
<h3 id="1321-date_sub-datediff">1321. 餐馆营业额变化增长  date_sub() / datediff()</h3>
<pre><code>### 计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值
Customer =
| customer_id | name    | visited_on | amount |
| ----------- | ------- | ---------- | ------ |
| 1           | Jhon    | 2019-01-01 | 100    |
| 2           | Daniel  | 2019-01-02 | 110    |
| 3           | Jade    | 2019-01-03 | 120    |
| 4           | Khaled  | 2019-01-04 | 130    |
| 5           | Winston | 2019-01-05 | 110    |
| 6           | Elvis   | 2019-01-06 | 140    |
| 7           | Anna    | 2019-01-07 | 150    |
| 8           | Maria   | 2019-01-08 | 80     |
| 9           | Jaze    | 2019-01-09 | 110    |
| 1           | Jhon    | 2019-01-10 | 130    |
| 3           | Jade    | 2019-01-10 | 150    |

### 答案1
SELECT distinct visited_on FROM Customer;
SELECT visited_on,sum(amount) as amount FROM Customer group by visited_on;
on (b.visited_on &gt;= date_sub(a.visited_on,interval 6 day)) and (b.visited_on &lt;= a.visited_on);
group by a.visited_on having date_sub(a.visited_on,interval 6 day) &gt;= (SELECT min(visited_on) FROM Customer);

SELECT a.visited_on as visited_on, sum(b.amount) as amount, round(sum(b.amount)/7,2) as average_amount 
FROM (SELECT distinct visited_on FROM Customer ) as a 
JOIN ( SELECT visited_on,sum(amount) as amount FROM Customer group by visited_on ) as b  
on (b.visited_on &gt;= date_sub(a.visited_on,interval 6 day)) and (b.visited_on &lt;= a.visited_on)
group by a.visited_on having date_sub(a.visited_on,interval 6 day) &gt;= (SELECT min(visited_on) FROM Customer) 
order by a.visited_on;

### 答案2
SELECT DISTINCT visited_on, sum_amount AS amount, ROUND(sum_amount/7, 2) AS average_amount 
FROM (SELECT visited_on,SUM(amount) OVER (ORDER BY visited_on RANGE BETWEEN INTERVAL '6' DAY PRECEDING AND CURRENT ROW) AS sum_amount FROM ( SELECT visited_on, SUM(amount) AS amount FROM Customer GROUP BY visited_on ) a ) b 
WHERE DATEDIFF(visited_on, (SELECT MIN(visited_on) FROM Customer)) &gt;= 6;

### 答案3
select visited_on, sum_amount as amount, round(sum_amount/7,2) as average_amount from 
( select visited_on, sum(amount) over(order by to_days(visited_on) range 6 preceding ) as sum_amount from
( select visited_on, sum(amount) as amount from Customer group by visited_on ) res ) r 
where datediff(visited_on, (select min(visited_on) from Customer) ) &gt;= 6
</code></pre>
<h3 id="1934-avg-if">1934. 确认率  AVG() / if()</h3>
<pre><code>### 确认率 是 'confirmed' 消息的数量除以请求的确认消息的总数
Signups =
| user_id | time_stamp          |
| ------- | ------------------- |
| 3       | 2020-03-21 10:16:13 |
| 7       | 2020-01-04 13:57:59 |
| 2       | 2020-07-29 23:09:44 |
| 6       | 2020-12-09 10:39:37 |
Confirmations =
| user_id | time_stamp          | action    |
| ------- | ------------------- | --------- |
| 3       | 2021-01-06 03:30:46 | timeout   |
| 3       | 2021-07-14 14:00:00 | timeout   |
| 7       | 2021-06-12 11:57:29 | confirmed |
| 7       | 2021-06-13 12:58:28 | confirmed |
| 7       | 2021-06-14 13:59:27 | confirmed |
| 2       | 2021-01-22 00:00:00 | confirmed |
| 2       | 2021-02-28 23:59:59 | timeout   |

### 答案
SELECT r.user_id, round(avg(r.flag), 2) as confirmation_rate FROM 
( SELECT s.user_id, if(action ='confirmed', 1, 0) as flag FROM Signups as s left join Confirmations as c 
on s.user_id = c.user_id ) as r group by r.user_id
</code></pre>
<hr />
<h3 id="181">181. 超过经理收入的员工</h3>
<pre><code>table Employee

| id | name  | salary | managerId |
| -- | ----- | ------ | --------- |
| 1  | Joe   | 70000  | 3         |
| 2  | Henry | 80000  | 4         |
| 3  | Sam   | 60000  | null      |
| 4  | MAX   | 90000  | null      |

### JOIN
SELECT e2.*, e1.* FROM Employee as e1 LEFT JOIN Employee as e2 
on e2.managerId = e1.id WHERE e2.managerId is not null

| id | name  | salary | managerId | id | name | salary | managerId |
| -- | ----- | ------ | --------- | -- | ---- | ------ | --------- |
| 1  | Joe   | 70000  | 3         | 3  | Sam  | 60000  | null      |
| 2  | Henry | 80000  | 4         | 4  | MAX  | 90000  | null      |

SELECT e2.name as Employee FROM Employee as e1 
LEFT JOIN Employee as e2 on e2.managerId = e1.id 
WHERE e2.managerId is not null and e2.salary &gt; e1.salary;

###答案 WHERE 
SELECT a.Name AS 'Employee' FROM Employee AS a, Employee AS b 
WHERE a.ManagerId = b.Id AND a.Salary &gt; b.Salary;
</code></pre>
<h3 id="184-dense_rank">184. 部门工资最高的员工  DENSE_RANK()</h3>
<pre><code>Employee = 
| id | name  | salary | departmentId |
| -- | ----- | ------ | ------------ |
| 1  | Joe   | 70000  | 1            |
| 2  | Jim   | 90000  | 1            |
| 3  | Henry | 80000  | 2            |
| 4  | Sam   | 60000  | 2            |
| 5  | MAX   | 90000  | 1            |

Department = 
| id | name  |
| -- | ----- |
| 1  | IT    |
| 2  | Sales |

| Department | Employee | Salary |
| ---------- | -------- | ------ |
| IT         | Jim      | 90000  |
| Sales      | Henry    | 80000  |
| IT         | MAX      | 90000  |

###答案 DENSE_RANK()
SELECT d.name as Department, e.name as Employee, e.salary as Salary FROM Department as d 
LEFT JOIN ( SELECT *, DENSE_RANK() OVER(PARTITION by departmentId order by salary desc) as 'rank' FROM Employee ) as e 
on d.id = e.departmentId and e.rank=1 WHERE e.salary is not null

###答案 JOIN  and (x, x) in (x, x)
SELECT Department.name AS 'Department', Employee.name AS 'Employee',Salary FROM Employee 
JOIN  Department ON Employee.DepartmentId = Department.Id 
WHERE (Employee.DepartmentId , Salary) IN (SELECT DepartmentId, MAX(Salary) FROM Employee GROUP BY DepartmentId )
</code></pre>
<h3 id="197-datediff-timestampdiff">197. 上升的温度 datediff() / TIMESTAMPDIFF()</h3>
<pre><code>Weather = 
| id | recordDate | temperature |
| -- | ---------- | ----------- |
| 1  | 2015-01-01 | 10          |
| 2  | 2015-01-02 | 25          |
| 3  | 2015-01-03 | 20          |
| 4  | 2015-01-04 | 30          |

###答案 datediff()  与之前的日期相比 温度更高的所有日期
SELECT w1.id as Id FROM Weather w1 , Weather w2  
WHERE datediff(w1.recordDate, w2.recordDate) = 1 and  w1.temperature &gt; w2.temperature ;

###答案 TIMESTAMPDIFF()
SELECT w1.Id FROM Weather as w1, Weather as w2 
WHERE TIMESTAMPDIFF(DAY, w2.RecordDate, w1.RecordDate) = 1 AND w1.Temperature &gt; w2.Temperature
</code></pre>
<h3 id="610-case-when-xx-then-x-else-x-end">610. 判断三角形  case when xx then x else x end</h3>
<pre><code>| x  | y  | z  |
| -- | -- | -- |
| 13 | 15 | 30 |
| 10 | 20 | 15 |

### 答案
SELECT x,y,z, (case when x+y &gt;z and x+z &gt;y and y+z &gt;x THEN 'Yes' ELSE 'No' END) as 'triangle' FROM triangle;
</code></pre>
<h3 id="626-lead-lag-if">626. 换座位  LEAD(), LAG() / IF()</h3>
<pre><code>### 交换每两个连续的学生的座位号。如果学生的数量是奇数，则最后一个学生的id不交换。
### LEAD(column_name, offset, default_value) OVER (PARTITION BY partition_expression ORDER BY sort_expression)  获取当前行后面的指定行数的值
### LAG(column_name, offset, default_value) OVER (PARTITION BY partition_expression ORDER BY sort_expression)  获取当前行前面的指定行数的值

考察SQL语句关键字执行的顺序: FROM &gt; WHERE &gt; GROUP BY &gt; HAVING &gt; SELECT &gt; ORDER BY
从执行顺序优先级可以看出，SELECT是倒数第二个执行的，ORDER BY在倒数第一个。所以我们可以对表数据执行修改然后通过排序得出结果。

从需求分析中可以看出，其实就是对id进行修改，如果id是奇数就+1，偶数则-1(WHEN MOD(id,2) != 0 AND c.end_id != id THEN id + 1 ELSE id - 1)

还要判断是否数量是否是奇数，如果是则最后一个不改(WHEN MOD(id,2) != 0 AND c.end_id = id THEN id)

判断数量我是通过新表来查询的( (SELECT COUNT(*) AS end_id FROM Seat) AS c)

Seat =
| id | student |
| -- | ------- |
| 1  | Abbot   |
| 2  | Doris   |
| 3  | Emerson |
| 4  | Green   |
| 5  | Jeames  |

SELECT id, IF(id &amp; 1, LEAD(student,1, student) OVER(), LAG(student, 1) OVER() ) AS student
FROM Seat

### 答案  IF()
SELECT if( id % 2 = 0, id-1, if( id = (SELECT max(id) FROM Seat ), id, id+1) ) as id, student FROM Seat order by id;

### 答案
SELECT a.id as id,ifnull(b.student,a.student) as student FROM Seat as a left join 
( SELECT * FROM Seat where mod(id,2) = 0 ) as b on (a.id+1) = b.id where mod(a.id,2) = 1
union
SELECT c.id as id,d.student as student FROM Seat as c left join 
( SELECT * FROM Seat where mod(id,2) = 1 ) as d on (c.id-1) = d.id where mod(c.id,2) = 0
order by id asc;
</code></pre>
<h3 id="1084-iii-count-sale_date-between-2019-01-01-and-2019-03-31-or-null">1084. 销售分析III count( sale_date between '2019-01-01' and '2019-03-31' or null )</h3>
<pre><code>| product_id | product_name | unit_price |
| ---------- | ------------ | ---------- |
| 1          | S8           | 1000       |
| 2          | G4           | 800        |
| 3          | iPhone       | 1400       |

## 所有售出日期都在这个时间内 = 在这个时间内售出的商品数量等于总商品数量

###答案  count( sale_date between '2019-01-01' and '2019-03-31' or null ) 
SELECT p.product_id, p.product_name FROM Sales as s left join Product as p on p.product_id=s.product_id 
group by product_id
having count( sale_date between '2019-01-01' and '2019-03-31' or null ) = count(*)
&lt;!-- having SUM(s.sale_date BETWEEN '2019-01-01' AND '2019-03-31') = COUNT(*) --&gt;

### 补集的思想：NOT IN
SELECT product_id, product_name FROM product  where product_id NOT IN 
(SELECT s.product_id FROM sales s where sale_date &lt; '2019-01-01' or sale_date &gt; '2019-03-31' )
and product_id in ( SELECT s.product_id FROM sales s )
</code></pre>
<h3 id="1174-ii-x-x-in-x-x-sumx-x">1174. 即时食物配送 II   (x, x) in (x, x) / SUM(x = x)</h3>
<pre><code>## 获取即时订单在所有用户的首次订单中的比例
### 即时订单 (order_date = customer_pref_delivery_date)，否则称为 计划订单
### 首次订单是顾客最早创建的订单,只有一个

Delivery =
| delivery_id | customer_id | order_date | customer_pref_delivery_date |
| ----------- | ----------- | ---------- | --------------------------- |
| 1           | 1           | 2019-08-01 | 2019-08-02                  |
| 2           | 2           | 2019-08-02 | 2019-08-02                  |
| 3           | 1           | 2019-08-11 | 2019-08-12                  |
| 4           | 3           | 2019-08-24 | 2019-08-24                  |
| 5           | 3           | 2019-08-21 | 2019-08-22                  |
| 6           | 2           | 2019-08-11 | 2019-08-13                  |
| 7           | 4           | 2019-08-09 | 2019-08-09                  |

###答案 (x, x) in (x, x)
SELECT round( SUM(order_date = customer_pref_delivery_date) /COUNT(1) *100 , 2) as immediate_percentage 
FROM Delivery where ( customer_id, order_date) in 
( SELECT customer_id,MIN(order_date) FROM Delivery group by customer_id )
</code></pre>
<h3 id="1193-i-if-sum-date_formatdate-format">1193. 每月交易 I  IF / SUM / DATE_FORMAT(date, format)</h3>
<pre><code>### 查询来查找每个月和每个国家/地区的事务数及其总金额、已批准的事务数及其总金额。
Transactions =
| id  | country | state    | amount | trans_date |
| --- | ------- | -------- | ------ | ---------- |
| 121 | US      | approved | 1000   | 2018-12-18 |
| 122 | US      | declined | 2000   | 2018-12-19 |
| 123 | US      | approved | 2000   | 2019-01-01 |
| 124 | DE      | approved | 2000   | 2019-01-07 |

### 错误思路  if(state='approved', +amount, 0) 
SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country ,COUNT(1) as trans_COUNT, SUM(state='approved') as approved_COUNT, SUM(amount) as trans_total_amount, if(state='approved', +amount, 0)  as approved_total_amount FROM Transactions group by month,country;

### 答案   SUM(if(state='approved', amount, 0)) / SUM(state='approved')
SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country ,COUNT(1) as trans_COUNT, SUM(state='approved') as approved_COUNT, SUM(amount) as trans_total_amount, SUM(if(state='approved', amount, 0))  as approved_total_amount FROM Transactions group by month,country;
</code></pre>
<h3 id="1321">1321. 餐馆营业额变化增长</h3>
<pre><code>### 计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值
Customer =
| customer_id | name    | visited_on | amount |
| ----------- | ------- | ---------- | ------ |
| 1           | Jhon    | 2019-01-01 | 100    |
| 2           | Daniel  | 2019-01-02 | 110    |
| 3           | Jade    | 2019-01-03 | 120    |
| 4           | Khaled  | 2019-01-04 | 130    |
| 5           | Winston | 2019-01-05 | 110    |
| 6           | Elvis   | 2019-01-06 | 140    |
| 7           | Anna    | 2019-01-07 | 150    |
| 8           | Maria   | 2019-01-08 | 80     |
| 9           | Jaze    | 2019-01-09 | 110    |
| 1           | Jhon    | 2019-01-10 | 130    |
| 3           | Jade    | 2019-01-10 | 150    |
</code></pre>
<h3 id="1789-union-if">1789. 员工的直属部门  UNION / IF()</h3>
<pre><code>### 查出员工所属的直属部门

Employee =
| employee_id | department_id | primary_flag |
| ----------- | ------------- | ------------ |
| 1           | 1             | N            |
| 2           | 1             | Y            |
| 2           | 2             | N            |
| 3           | 3             | N            |
| 4           | 2             | N            |
| 4           | 3             | Y            |
| 4           | 4             | N            |

### 答案 union
SELECT employee_id, department_id FROM Employee  group by employee_id having count(department_id) = 1
union 
SELECT employee_id, department_id FROM Employee where primary_flag = 'Y';

### 答案 if(condition, Y, N)
SELECT e1.employee_id,if(count(e1.department_id) &lt; 2,e1.department_id,(SELECT department_id FROM Employee e2 
where e2.employee_id = e1.employee_id and e2.primary_flag = 'Y')) department_id
FROM Employee e1 group by e1.employee_id having department_id is not null;
</code></pre>
<h3 id="1934-avg-ifnull">1934. 确认率  AVG() IFNULL</h3>
<pre><code>Signups =
| user_id | time_stamp          |
| ------- | ------------------- |
| 3       | 2020-03-21 10:16:13 |
| 7       | 2020-01-04 13:57:59 |
| 2       | 2020-07-29 23:09:44 |
| 6       | 2020-12-09 10:39:37 |

Confirmations =
| user_id | time_stamp          | action    |
| ------- | ------------------- | --------- |
| 3       | 2021-01-06 03:30:46 | timeout   |
| 3       | 2021-07-14 14:00:00 | timeout   |
| 7       | 2021-06-12 11:57:29 | confirmed |
| 7       | 2021-06-13 12:58:28 | confirmed |
| 7       | 2021-06-14 13:59:27 | confirmed |
| 2       | 2021-01-22 00:00:00 | confirmed |
| 2       | 2021-02-28 23:59:59 | timeout   |

### 思路
SELECT * FROM Signups as s LEFT JOIN Confirmations as c on s.user_id=c.user_id;

SELECT user_id, COUNT(1) as COUNT,action FROM Confirmations group by user_id,action

### 答案  AVG(c.action='confirmed')
SELECT s.user_id, ROUND(IFNULL(AVG(c.action='confirmed'), 0), 2) AS confirmation_rate
FROM Signups AS s LEFT JOIN Confirmations AS c ON s.user_id = c.user_id GROUP BY s.user_id
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
    
  </body>
</html>